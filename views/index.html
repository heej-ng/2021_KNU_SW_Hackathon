<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <title>Smart Campus</title>
    <style>
        * {
            padding : 0; 
            margin: 0;
        }
        canvas {
            background: #eee; 
            display: block; 
            margin : 0 auto;
        }
    </style>
    
    <script src="/socket.io/socket.io.js"></script>
    <script language="javascript" type="text/javascript" src="/views/roomObject.js"></script>
    <script language="javascript" type="text/javascript" src="/views/userObject.js"></script>
    <script language="javascript" type="text/javascript" src="/views/rooms.js"></script>
</head>
<body>
   <div style = "text-align: center;">
    <font size = "8em" color = "red" font-weight = "bold">
        <b>Smart Campus</b>
    </font>
  </div>
    <h1 style = "text-align: center;">IT5</h1>
    <canvas id = "myCanvas" width ="1024" height = "768"></canvas>
  
    <script>
        var map = '/views/img/map.png';
        var canvas = document.getElementById("myCanvas");
        var ctx = canvas.getContext("2d");
        var radius = 20
        var playerSpeed = 4

        var rightPressed = false;
        var leftPressed = false;
        var upPressed = false;
        var downPressed = false;
        
        var balls  = [];
        var ballMap = {};
        var myId;

        document.addEventListener("keydown", keyDownHandler,false);
        document.addEventListener("keyup", keyUpHandler,false);

        function keyDownHandler(e){
            if (e.code == 'ArrowRight'){
                rightPressed = true;
            }
            if (e.code == 'ArrowLeft'){
                leftPressed = true;
            }
            if(e.code == "ArrowDown"){
                downPressed = true;
            }
            if(e.code == "ArrowUp"){
                upPressed = true;
            }
        }

        function keyUpHandler(e){
            if (e.code == "ArrowRight"){
                rightPressed = false;
            }
            if (e.code == "ArrowLeft"){
                leftPressed = false;
            }
            if(e.code == "ArrowDown"){
                downPressed = false;
            }
            if(e.code == "ArrowUp"){
                upPressed = false;
            }
        }

        function joinUser(id,color,x,y){
            let ball = new PlayerBall(id);
            ball.color = color;
            ball.x = x;
            ball.y = y;

            balls.push(ball);
            ballMap[id] = ball;

            return ball;
        }

        function leaveUser(id){
            for(var i = 0 ; i < balls.length; i++){
                if(balls[i].id == id){
                    balls.splice(i,1);
                    break;
                }
            }
            delete ballMap[id];
        }

        function updateState(id,x,y){
            let ball = ballMap[id];
            if(!ball){
                return;
            }
            ball.x = x;
            ball.y = y;

        }
        function sendData() {
            let curPlayer = ballMap[myId];
            let data = {};
            data = {
                id : curPlayer.id,
                x: curPlayer.x,
                y: curPlayer.y,
            };
            if(data){
                socket.emit("send_location", data);
            }
        }

        function roomDetection() {
            let ball = ballMap[myId];
            var roomId;
            for (var i=0; i<rooms.length; i++) {
                if ((ball.getX()+450 < rooms[i].getX() + rooms[i].getWidth()) && ball.getY() == rooms[i].getY()) {
                    roomId = rooms[i].getId()                   
                    alert(roomId + '호로 입장합니다.');
                    socket.emit('enterRoom', {roomId: roomId, ballId: myId});
                    location.href = "./room";
                    break;
                }
            }
        }

        var rooms = [];

        var socket = io();

        socket.on('user_id', function(data){
            myId = data;
        });
        socket.on('join_user', function(data){
            joinUser(data.id, data.color, data.x, data.y);
        })
        socket.on('leave_user', function(data){
            leaveUser(data);
        })
        socket.on('update_state', function(data){
            updateState(data.id, data.x, data.y);
        }) 

        function renderPlayer() {       
                for (let i = 0; i < balls.length; i++) {
                    let ball = balls[i];
                    
                    ctx.fillStyle = ball.color;
                    ctx.beginPath();
                    ctx.arc(ball.x, ball.y, radius, 0, Math.PI * 2, false);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.font = '15px Arial';
                    ctx.fillText(`player ${i}`,ball.x-radius-7, ball.y-radius);
                    ctx.closePath();
                }

                let curPlayer = ballMap[myId];
                
                if (rightPressed){
                    curPlayer.x += playerSpeed;
                }
                if (leftPressed ){
                    curPlayer.x -= playerSpeed;
                }
                if(upPressed ){
                    curPlayer.y -= playerSpeed;
                }
                if(downPressed ){
                    curPlayer.y += playerSpeed;
                }
                sendData();
        }

        function renderMap(){
            var img = new Image;
            img.src = map;
            ctx.beginPath();
            ctx.drawImage(img,0,0, 1024, 768);
            ctx.closePath();
        }
        
        function update() {
            renderMap();
            roomDetection();
            renderPlayer();
        }
        
        setInterval(update, 10);
        

    </script>
    <script>
        let browserPoint = (event)=>{
            console.log(`브라우저 좌표 : (${event.pageX}, ${event.pageY})`);
        }
        let clientPoint = (event) =>{
            console.log(`화면 좌표 : (${event.clientX}, ${event.clientY})`);
        }
        window.addEventListener('click',e=>{
            browserPoint(e);
            clientPoint(e);
        });

    </script>
    

</body>
</html>